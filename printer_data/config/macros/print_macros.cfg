[gcode_macro PRINT_START]
gcode:
  ##### PARAMETERS #####
  {% set svv = printer.save_variables.variables %}  ; Load the saved variables to grab the wipe location
  {% set BED = params.BED|default(60)|float %}
  {% set EXTRUDER = params.EXTRUDER|default(200)|float %}
  {% set CHAMBER = params.CHAMBER|default(0)|float %}
  {% set MATERIAL = params.MATERIAL|default("PLA")|string %}
  {% set PA = params.PA|default(0)|float %}
  {% set PAENABLE = params.PAENABLE|default('false')|string|lower %}
  {% set TOTAL_LAYERS = params.TOTAL_LAYERS|default(0)|int %}

  ##### STATUS / INFO #####
  M400  ; Wait for the buffer to clear
  SET_PRINT_STATS_INFO TOTAL_LAYER={TOTAL_LAYERS}
  RESPOND MSG="PRINT_START: BED={BED}C, EXTRUDER={EXTRUDER}C, CHAMBER={CHAMBER}C, MAT={MATERIAL}"

  ##### SET THE LED LIGHTS #####
  SET_PIN PIN=caselight VALUE=1  ; Turn on the caselight
  SET_LED LED=sb_leds RED=1 GREEN=0 BLUE=0 WHITE=0 INDEX=1 transmit=0  ; Set the logo to red during heating
  SET_LED LED=sb_leds RED=0 GREEN=0 BLUE=0 WHITE=1 INDEX=2 transmit=0  ; Set the headlights to white during printing
  SET_LED LED=sb_leds RED=0 GREEN=0 BLUE=0 WHITE=1 INDEX=3  ; Set the headlights to white during printing

  M140 S{BED}  ; Set bed temp (no wait yet)

  G90  ; Absolute Positioning
  G28  ; Home all Axis
  QUAD_GANTRY_LEVEL  ; Level the Gantry

  ##### CLEAN NOZZLE THEN RAISE AND Z REHOME #####
  G0 X{ svv.nozzle_wipe_x } Y{ svv.nozzle_wipe_y } F6000   ; Set the position for filament purging
  G0 Z{ svv.nozzle_wipe_z }   ; Set the height for filament purging 
  M109 S140  ; Set the nozzle temp and wait
  CLEAN_NOZZLE  ; Wipe the nozzle
  G0 Z5  ; Raise the nozzle so that it's above the bed
  
  ##### WAIT FOR BED TO STABILIZE #####
  M190 S{BED}  ; Wait for bed temp
  

  ##### CALIBRATE BED MESH WITH KAMP #####
  G28 Z METHOD=CONTACT CALIBRATE=1  ; Rehome the Z with what should now be a clean nozzle
  BED_MESH_CALIBRATE ADAPTIVE=1  ; Create the bed mesh, KAMP replaces the original macro
  SMART_PARK  ; Calls the KAMP smart_park macro

  ##### WAIT FOR CHAMBER TEMPERATURE #####
  {% if CHAMBER > 20 %}  ; Check to see if the Chamber temp is set in the filament profile
    SET_LED LED=sb_leds RED=1 GREEN=1 BLUE=0 WHITE=0 INDEX=1  ; Set the logo to yellow while waiting on chamber temp
    TEMPERATURE_WAIT SENSOR=chamber_temp MINIMUM={ CHAMBER } MAXIMUM={ CHAMBER+50 }   ; Wait for the chamber to reach the requested temperature
  {% endif %}

  ##### TURN ON AIR FILTRATION #####
  {% if CHAMBER > 0 %}
    RESPOND MSG="Nevermore: ON (CHAMBER={CHAMBER})"
    SET_FAN_SPEED FAN=nevermore SPEED=1.0
  {% else %}
    RESPOND MSG="Nevermore: OFF"
    SET_FAN_SPEED FAN=nevermore SPEED=0.0
  {% endif %}

  ##### SET HOTEND PRINT TEMP AND OFFSET #####
  SET_LED LED=sb_leds RED=0 GREEN=1 BLUE=1 WHITE=0 INDEX=1  ; Set the logo to cyan while waiting on extruder temp
  M109 S{ EXTRUDER }  ; Set the nozzle temp and wait
  SET_GCODE_OFFSET Z=0.03     ; add a little offset for hotend thermal expansion per Beacon Documentation

  ##### ENABLE PRESSURE ADVANCE #####
  {% if PA > 0 and PAENABLE == 'true' %}  ; Check to make sure PA is enabled from the slicer and that the value is not 0
    SET_PRESSURE_ADVANCE ADVANCE={PA}
  {% else %}
    RESPOND MSG="PA disabled for this print"
  {% endif %}

  ##### PRINT THE PRIME LINE #####
  LINE_PURGE  ; Calls the KAMP purge line

  ##### RESET EXTRUDER TO 0 #####
  G92 E0   ; Set the position of the extruder back to 0, this should be the last command after the prime line
  SET_LED LED=sb_leds RED=0 GREEN=0 BLUE=0 WHITE=1 INDEX=1  ; Set the logo to white while printing

[gcode_macro PRINT_END]
gcode:
  {% set svv = printer.save_variables.variables %}  ; Load the saved variables to grab the wipe location
  M400  ; Wait for all buffered moves to complete

  ##### GET & SAVE STATE #####
  {% set macro_state = printer["gcode_macro PRINT_END"] %}
  {% set E = printer.extruder.position %}

  ##### RETRACT #####
  G91  ; Relative Positioning
  G1 E{ svv.nozzle_retract }  F1800  ; Small retract

  ##### CORKSCREW Z-HOP #####
  {% set requested_lift = 5.0 %}
  {% set max_lift = printer.toolhead.axis_maximum.z - printer.toolhead.position.z - 1.0 %}
  {% if max_lift <= 0 %}
    {% set lift = 0.0 %}
  {% elif max_lift < requested_lift %}
    {% set lift = max_lift %}
  {% else %}
    {% set lift = requested_lift %}
  {% endif %}

  {% set segments = 16 %}
  {% if lift > 0 %}
    {% set dz = lift / segments %}
  {% else %}
    {% set dz = 0.0 %}
  {% endif %}
  {% set step_xy = 2.0 %}
  {% set dx = step_xy %}
  {% set dy = 0.0 %}

  {% for i in range(segments) %}
    G1 X{dx} Y{dy} Z{dz} F6000               ; spiral-ish move up and away
    {% set old_dx = dx %}
    {% set dx = -dy %}
    {% set dy = old_dx %}
  {% endfor %}

  ##### PARK BACK-RIGHT #####
  G90  ; Absolute Positioning
  {% set park_x = printer.toolhead.axis_maximum.x - 5 %}
  {% set park_y = printer.toolhead.axis_maximum.y - 5 %}
  G1 X{park_x} Y{park_y} F15000  ; Park back-right, 5mm in from limits
  
  ##### TURN OFF HOTEND, BED, PART COOLING, CHAMBER FILTRATION #####
  M104 S0  ; Hotend off
  M140 S0  ; Bed off
  M107     ; Part cooling off
  SET_FAN_SPEED FAN=nevermore SPEED=0  ; Nevermore / chamber filtration off

  ##### DISABLE PRESSURE ADVANCE & RESET EXTRUDER #####
  SET_PRESSURE_ADVANCE ADVANCE=0  ; Clear pressure advance
  G92 E0  ; Reset extruder position to 0

  ##### CLEAR BED MESH & Z-OFFSET #####
  BED_MESH_PROFILE REMOVE=default  ; Clear active bed mesh
  SET_GCODE_OFFSET Z=0  ; Clear the Z-offset that was set in print_start

  ##### DISABLE STEPPERS #####
  M84 X Y Z E  ; Disable X/Y/Z/E steppers

  ##### SET THE LED LIGHTS #####
  SET_LED LED=sb_leds RED=0 GREEN=0 BLUE=1 WHITE=0 INDEX=1 transmit=0  ; Set the headlights to blue
  SET_LED LED=sb_leds RED=0 GREEN=0 BLUE=1 WHITE=0 INDEX=2 transmit=0  ; Set the headlights to blue
  SET_LED LED=sb_leds RED=0 GREEN=0 BLUE=1 WHITE=0 INDEX=3  ; Set the headlights to blue

  RESPOND MSG="PRINT_END complete: parked, heaters/fans off, PA disabled, mesh cleared."

[gcode_macro AFTER_LAYER_CHANGE]
description: Report layer change to KlipperScreen
gcode:
  {% set CURRENT_LAYER = params.LAYER|default(0)|int %}
  SET_PRINT_STATS_INFO CURRENT_LAYER={CURRENT_LAYER}
  # You can add other things here later (like timelapse triggers)